<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Multi-B2&W2</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <link href="css/reset.css" rel="stylesheet" />
    <link href="css/main.css" rel="stylesheet" />
    <!--<script src="js/oauth.js"></script>-->
    <script src="js/jquery.min.js"></script>
    <script>
        $(document).ready(function (data) {
            var uid = 0, uname = 'debug';//debug数据
            var clientId = '3GMv3CfMcLTSOuHyffkwieIx', rate = 200, gameurl = switchversion(uid);//基本参数
            var screen = $('#screen img'), chatrecord = $('#chatrecord'), keyrecord = $('#keyrecord');//基本元素
            var btnchat = $('#chat button'), txtchat = $('#chat input'), btnkeypad = $('#keypad button'); //互动元素

            function auth() {
                if (uid) {
                    var accessToken = location.hash.substr(location.hash.indexOf('access_token='));
                    accessToken = accessToken.substr(0, accessToken.indexOf('&'));
                    var restUrl = 'https://openapi.baidu.com/rest/2.0/passport/users/getLoggedInUser?' + accessToken + '&callback=?'

                    $.getJSON(restUrl).done(function (data) {
                        if ('error_msg' in data)
                        { return document.write(data.error_msg); }
                        else {
                            recode(data)
                        }
                    });
                }
                else {
                    login();
                }
            }//认证
            function login() {

                var oAuthUrl = [
                  'https://openapi.baidu.com/oauth/2.0/authorize?response_type=token',
                  'client_id=' + clientId,
                  'redirect_uri=' + location.protocol + '//' + location.host
                ].join('&');
                if (location.hash.indexOf('access_token=') === -1)
                    return location.href = oAuthUrl;
            }//登陆
            function recode(udata) { uid = udata.uid; uname = udata.uname; alert(uname);}//基本变量重赋值
            function switchversion(uid) {
                switch (uid % 2) {
                    case 0: gameurl = 'http://black.s.gerhut.me/'; return gameurl;
                    case 1: gameurl = 'http://white.s.gerhut.me/'; return gameurl;
                    default: gameurl = 'http://black.s.gerhut.me/'; return gameurl;
                }
            }//根据uid奇偶切换版本
            function sendkey(keycode) {
                $.get('http://bwinput.s.gerhut.me/key/input?name=' + uname + '&key=' + keycode);
            }//发送按键
            function sendmouse(x, y) {
                if (x >= 0 && y >= 0) $.get('http://bwinput.s.gerhut.me/touch/input?name=' + uname + '&touch=' + x + ',' + y);
            }//发送鼠标
            function sendmessage() {
                var message = $('#chat input')
                if (message.val() != '' && message.val.length <= 40) {
                    $.get('http://bwinput.s.gerhut.me/chat?name=' + uname + '&content=' + message.val());
                    message.val('');
                }
            }//发送聊天
            function refresh() {
                $(screen).ready(function () {
                    screen.attr('src', gameurl + '?' + Date.now());
                })
                setTimeout(refresh, rate);
            }//刷新游戏屏幕
            function refreshchat() {
                $(chatrecord).ready(function () {
                    chatrecord.load('http://bwinput.s.gerhut.me/chat', function () { chatrecord.text(decodeURIComponent(chatrecord.text().split('\n').reverse().join('\n'))) });

                })
                setTimeout(refreshchat, rate);
            }//刷新聊天记录
            function refreshkey() {
                $(keyrecord).ready(function () {
                    keyrecord.load('http://bwinput.s.gerhut.me/key', function () { keyrecord.text(decodeURIComponent(keyrecord.text().split('\n').reverse().join('\n'))) });
                })
                setTimeout(refreshkey, rate);
            }//刷新按键记录
            function init() {
                //auth();
                refresh();
                refreshchat();
                refreshkey();
                btnchat.click(function () {
                    sendmessage();
                })
                txtchat.keypress(function (e) {
                    if (e.which == 13) sendmessage();
                })
                btnkeypad.click(function () {
                    sendkey($(this).val())
                })
                screen.click(function () {
                    sendmouse(Math.round(event.offsetX), Math.round(event.offsetY) - 192);
                })
            }//入口

            init();//调用入口
        })
    </script>
</head>
<body>
    <div id="container">
        <div id="screen"><img src="/images/default.png" /></div>
        <div id="controlpad">
            <div id="keypad">
                <table>
                    <tbody>
                        <tr>
                            <td></td>
                            <td><button value="up">↑</button></td>
                            <td></td>
                            <td></td>

                            <td></td>
                            <td></td>
                            <td><button value="X">X</button></td>
                            <td></td>
                        </tr>
                        <tr>
                            <td><button value="left">←</button></td>
                            <td></td>
                            <td><button value="right">→</button></td>
                            <td></td>

                            <td></td>
                            <td><button value="Y">Y</button></td>
                            <td></td>
                            <td><button value="A">A</button></td>
                        </tr>
                        <tr>
                            <td></td>
                            <td><button value="down">↓</button></td>
                            <td></td>
                            <td><button value="start">始</button></td>

                            <td><button value="select">选</button></td>
                            <td></td>
                            <td><button value="B">B</button></td>
                            <td></td>
                        </tr>
                        <tr></tr>
                    </tbody>
                </table>
            </div>
            <div id="chat">
                <input /><button>send</button>
                <pre id="chatrecord"></pre>
                <pre id="keyrecord"></pre>
            </div>
        </div>
        <br style="clear:both" />
    </div>
</body>
</html>
